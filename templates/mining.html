{% extends 'base.html' %}

{% block mining_crypto %}
<div class="d-flex justify-content-center" style="margin-top: 2%;">
    <div style="width: 70%;">
        <h1 class="text-center">Mine Cryptocurrency</h1>

        <form id="mineForm" method="POST" action="{% url 'mining_crypto' %}">
            {% csrf_token %}
            <div class="mb-3" style="margin-top: 3%;">
                <label for="transactions" class="form-label">Transactions (JSON Format):</label>
                <textarea class="form-control" id="transactions" name="transactions" rows="10"
                    style="font-size: 18px; padding: 10px;" placeholder="{'from_send': 'b6d90753bde2c1d3d31839e0a4cd03933fa2a90bf80f18e0b6e5519fbb29d91f', 'amount': 1.0, 'timestamp': '2025-03-23 04:11:40'}" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">Start Mining</button>
        </form>

        <div id="miningStatus" class="text-center mt-4 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Mining...</span>
            </div>
            <p class="mt-3">Mining in progress. Please wait...</p>
        </div>

        <div id="miningResult" class="alert alert-success mt-4 d-none" role="alert">
            Mining completed successfully, enter the Nonce number as soon as possible to receive the reward! Nonce: <span id="nonceValue"></span>
        </div>

        <div id="miningError" class="alert alert-danger mt-4 d-none" role="alert">
            Mining failed. Please try again.
        </div>
    </div>
</div>

<script>
    const form = document.getElementById('mineForm');
    const miningStatus = document.getElementById('miningStatus');
    const miningResult = document.getElementById('miningResult');
    const miningError = document.getElementById('miningError');
    const nonceValue = document.getElementById('nonceValue');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        miningStatus.classList.remove('d-none');
        miningResult.classList.add('d-none');
        miningError.classList.add('d-none');

        const transactions = document.getElementById('transactions').value;

        try {
            const response = await fetch("{% url 'mining_crypto' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ transactions })
            });

            const data = await response.json();
            miningStatus.classList.add('d-none');

            if (response.ok && data.success) {
                nonceValue.textContent = data.nonce;
                miningResult.classList.remove('d-none');
            } else {
                miningError.classList.remove('d-none');
            }
        } catch (error) {
            miningStatus.classList.add('d-none');
            miningError.classList.remove('d-none');
        }
    });
</script>
{% endblock mining_crypto %}
