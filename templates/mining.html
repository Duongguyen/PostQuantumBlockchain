{% extends 'base.html' %}

{% block mining_crypto %}
<div class="mining-container">
    <h1 class="text-center" style="top: 2cm;">Mine Cryptocurrency</h1>
    <form id="mineForm" method="POST" style="top: 3cm;" action="{% url 'mining_crypto' %}">
        {% csrf_token %}
        <div class="mb-3" style="top: 3cm;">
            <label for="transactions" class="form-label">Transactions (JSON Format):</label>
            <textarea class="form-control" id="transactions" name="transactions" rows="10" style="font-size: 18px; padding: 10px;" placeholder='[{ "from_send": "Alice", "amount": 10.5, "timestamp": "YYYY-MM-DD HH:MM:SS"}]' required></textarea>
        </div>
        <button type="submit" class="btn btn-primary w-100">Start Mining</button>
    </form>

    <div id="miningStatus" class="text-center mt-4 d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Mining...</span>
        </div>
        <p class="mt-3">Mining in progress. Please wait...</p>
    </div>

    <div id="miningResult" class="alert alert-success mt-4 d-none" role="alert">
        Mining completed successfully, enter the Nonce number as soon as possible to receive the reward ! Nonce: <span id="nonceValue"></span>
    </div>

    <div id="miningError" class="alert alert-danger mt-4 d-none" role="alert">
        Mining failed. Please try again.
    </div>
</div>
<script>
    const form = document.getElementById('mineForm');
    const miningStatus = document.getElementById('miningStatus');
    const miningResult = document.getElementById('miningResult');
    const miningError = document.getElementById('miningError');
    const nonceValue = document.getElementById('nonceValue');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        miningStatus.classList.remove('d-none');
        miningResult.classList.add('d-none');
        miningError.classList.add('d-none');

        const transactions = document.getElementById('transactions').value;

        try {
            const response = await fetch("{% url 'mining_crypto' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ transactions })
            });

            const data = await response.json();
            miningStatus.classList.add('d-none');

            if (response.ok && data.success) {
                nonceValue.textContent = data.nonce;
                miningResult.classList.remove('d-none');
            } else {
                miningError.classList.remove('d-none');
            }
        } catch (error) {
            miningStatus.classList.add('d-none');
            miningError.classList.remove('d-none');
        }
    });
</script>
{% endblock mining_crypto %}
